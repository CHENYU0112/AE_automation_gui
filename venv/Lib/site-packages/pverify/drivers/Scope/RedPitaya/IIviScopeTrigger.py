# -------------------------------------------------------------------------------
# Name           :
# Description    :
#
# Revision       : $Rev$
# Date           : $Date$
# Last change by : $Author$
# -------------------------------------------------------------------------------
from __future__ import annotations

from pverify.drivers.BaseInstrument import InstrumentError
from pverify.drivers.Scope.RedPitaya import IIviScopeBase, IIviScopeTriggerEdge


class IIviScopeTrigger(IIviScopeBase.IIviScopeBase):
    """IVI Scope class-compliant trigger interface.

    NOTE:
        Attributes/Methods marked with '#' do not exist for this instrument.
        Attributes/Methods marked with '*' are specific for this instrument.
        !Please consider when trying to program instrument independent.

    Attributes:
        #AcLine
            Pointer to the class-compliant IIviScopeTriggerAcLine interface
        Edge
            Pointer to the class-compliant IIviScopeTriggerEdge interface
        #Glitch
            Pointer to the class-compliant IIviScopeTriggerGlitch interface
        #Runt
            Pointer to the class-compliant IIviScopeTriggerRunt interface
        #TV
            Pointer to the class-compliant IIviScopeTriggerTv interface
        #Width
            Pointer to the class-compliant IIviScopeTriggerWidth interface

        #Continuous [Boolean] [rw]
            If True, the oscilloscope waits trigger holdoff seconds after a
            waveform acquisition is complete and then immediately enters the
            wait for trigger state without passing through the idle state.

        Coupling [String] [rw]
            How the oscilloscope couples the trigger source.

        Level [Float] [rw]
            The voltage threshold for the trigger subsystem. The units are volts.
            Use with float value.

        #Modifier [String] [rw]
            The trigger modifier determines the oscilloscope's behavior in the absence of a trigger.

        Source [Int] [rw]
            The signal the oscilloscope monitors for a trigger.
            It can be channel or one of many other values.
            Values: 1-8

        Holdoff [Float] [rw]
            The length of time the oscilloscope waits after it fills the
            acquisition buffer until the oscilloscope enables the trigger
            subsystem to detect another trigger. The units are seconds.
            Use with float value.

        Type [String] [rw]
            The kind of event that triggers the oscilloscope.

    Methods:
        Configure
            Configures trigger Type and Holdoff. Holdoff units are seconds.



    """

    def __init__(self, parent):
        self.parent = parent
        if False:
            from .IIviScope import IIviScope

            self.parent = IIviScope()
        IIviScopeBase.IIviScopeBase.__init__(self, self.parent.interface)

        self.Edge = IIviScopeTriggerEdge.IIviScopeTriggerEdge(self, self.interface)
        self.__Continuous = True

    @property
    def Continuous(self):
        """
        If True, the oscilloscope waits trigger holdoff seconds after a
        waveform acquisition is complete and then immediately enters the wait
        for trigger state without passing through the idle state.
        """
        return self.__Continuous

    @Continuous.setter
    def Continuous(self, value):
        """
        If True, the oscilloscope waits trigger holdoff seconds after a
        waveform acquisition is complete and then immediately enters the wait
        for trigger state without passing through the idle state.
        """
        self.__Continuous = bool(value)

    @property
    def Coupling(self):
        """
        How the oscilloscope couples the trigger source.

        :rtype: IviScopeTriggerCouplingEnum
        """
        return self.Enums.IviScopeTriggerCouplingEnum.IviScopeTriggerCouplingDC

    @Coupling.setter
    def Coupling(self, value):
        """
        How the oscilloscope couples the trigger source.

        :type value: IviScopeTriggerCouplingEnum
        """
        if value != self.Enums.IviScopeTriggerCouplingEnum.IviScopeTriggerCouplingDC:
            errMsg = "ErrCode:xx, ErrMsg:'Only DC trigger coupling is supported!'"
            self.interface._Log.error(errMsg)
            raise InstrumentError(errMsg)

    @property
    def Level(self):
        """
        The voltage threshold for the trigger subsystem. The units are volts.

        :rtype: float
        """
        pa = self.TriggerPA()
        ret = self.interface.vi_query(":ACQ:TRIG:LEV?", rformat="%f\n")
        self.GetError()
        return ret * pa

    @Level.setter
    def Level(self, value):
        """
        The voltage threshold for the trigger subsystem. The units are volts.

        :type value: float
        """
        val = value / self.TriggerPA()
        val = min(1, max(-1, val))  # FIXME HV,LV setting
        self.interface.vi_write(f":ACQ:TRIG:LEV {val:f}")
        self.GetError()

    @property
    def Modifier(self):
        """
        The trigger modifier determines the oscilloscope's behavior in the absence of a trigger.

        :rtype: IviScopeTriggerModifierEnum
        """
        return self.Enums.IviScopeTriggerModifierEnum.IviScopeTriggerModifierNone

    @Modifier.setter
    def Modifier(self, value):
        """
        The trigger modifier determines the oscilloscope's behavior in the absence of a trigger.

        :type value: IviScopeTriggerModifierEnum
        """
        if value != self.Enums.IviScopeTriggerModifierEnum.IviScopeTriggerModifierNone:
            msg = "Redpitaya: Only IviScopeTriggerModifierNone is supported!"
            raise ValueError(msg)

    @property
    def Source(self):
        """
        The signal the oscilloscope monitors for a trigger.

        :rtype: int
        """
        return self.Edge.Source

    @Source.setter
    def Source(self, value):
        """
        The signal the oscilloscope monitors for a trigger. It can be channel or one of many other values.

        :type value: int
        """
        self.Edge.Source = value

    @property
    def Holdoff(self):
        """
        The length of time the oscilloscope waits after it fills the
        acquisition buffer until the oscilloscope enables the trigger
        subsystem to detect another trigger. The units are seconds.

        :rtype: float
        """
        raise NotImplementedError

    @Holdoff.setter
    def Holdoff(self, value):
        """
        The length of time the oscilloscope waits after it fills the
        acquisition buffer until the oscilloscope enables the trigger
        subsystem to detect another trigger. The units are seconds.

        :type value: float
        """
        raise NotImplementedError

    @property
    def Type(self):
        """
        The kind of event that triggers the osciolloscope.

        :rtype: IviScopeTriggerTypeEnum
        """
        return self.Enums.IviScopeTriggerTypeEnum.IviScopeTriggerEdge

    @Type.setter
    def Type(self, value):
        """
        The kind of event that triggers the osciolloscope.

        :type value: IviScopeTriggerTypeEnum
        """
        if value != self.Enums.IviScopeTriggerTypeEnum.IviScopeTriggerEdge:
            errMsg = "ErrCode:xx, ErrMsg:'Only edge trigger is supported!'"
            self.interface._Log.error(errMsg)
            raise InstrumentError(errMsg)

    # Methods
    def Configure(self, Type, Holdoff):
        """
        Configures trigger Type and Holdoff. Holdoff units are seconds.

        :param Type: Specifies the trigger type. This value sets the Trigger Type property.
        :type Type: IviScopeTriggerTypeEnum

        :param Holdoff: Specifies the trigger hold-off. This value sets the Trigger Holdoff property.
        :type Holdoff: float
        """
        self.Type = Type
        self.Holdoff = Holdoff

    def ForceTrigger(self):
        """
        Forces the scope to trigger.
        """
        self.interface.vi_write("ACQ:TRIG NOW")
        self.GetError()

    def TriggerPA(self):
        """
        Return probe attenuation level of trigger channel.

        :return: float
        """
        ts = self.Source
        try:
            cn = self.parent.Channels.Name(ts)
            tc = self.parent.Channels.Item(cn)
            return tc.ProbeAttenuation
        except Exception:
            return 1.0
