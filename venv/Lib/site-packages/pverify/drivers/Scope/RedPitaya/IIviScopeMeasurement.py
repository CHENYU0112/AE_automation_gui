# -------------------------------------------------------------------------------
# Name           :
# Description    :
#
# Revision       : $Rev$
# Date           : $Date$
# Last change by : $Author$
# -------------------------------------------------------------------------------
from __future__ import annotations

from time import perf_counter, sleep

from pyvisa.constants import VI_ATTR_TMO_VALUE

from pverify.drivers.Scope.RedPitaya import IIviScopeBase


class IIviScopeMeasurement(IIviScopeBase.IIviScopeBase):
    """IVI Scope class-compliant measurement interface.

    NOTE:
        Attributes/Methods marked with '#' do not exist for this instrument.
        Attributes/Methods marked with '*' are specific for this instrument.
        !Please consider when trying to program instrument independent.

    Methods:
        FetchWaveform
            Returns a previously acquired waveform for this channel.
            The acquisition must be made prior to calling this method.
            Call this method separately for each channel.

        #FetchWaveformMeasurement
            Returns a previously acquired waveform measurement for this channel.
            The acquisition must be made prior to calling this method.
            Call this method separately for each measurement.

        #FetchWaveformMinMax
            Returns the previously acquired minimum and maximum waveforms
            for this specified channel. The acquisition must be made prior
            to calling this method. Call this method separately for each channel.

        ReadWaveform
            Initiates an acquisition on all enabled channels, waits
            (up to MaxTime) for the acquisition to complete, and returns
            the waveform for this channel. Call FetchWaveform to obtain the
            waveforms for other channels.

        #ReadWaveformMeasurement
            Initiates an acquisition on all enabled channels, waits
            (up to MaxTime) for the acquisition to complete, and returns
            the measurement for this channel. Call FetchWaveformMeasurement
            to obtain other measurements for this or other channels.

        #ReadWaveformMinMax
            Initiates an acquisition on all enabled channels, waits
            (up to MaxTime) for the acquisition to complete, and returns
            the min/max waveforms for this channel. Call FetchMinMaxWaveform
            to obtain the min/max waveforms for other channels.

    """

    def __init__(self, parent, interface, Channelname):
        self.parent = parent
        self._Channel = Channelname
        IIviScopeBase.IIviScopeBase.__init__(self, interface)

    # Methods
    def FetchWaveform(self):
        """
        Returns a previously acquired waveform for this channel. The
        acquisition must be made prior to calling this method.
        Call this method separately for each channel.

        :return: Returns a waveform datatype as dictionary of form {"time_scope": <np.ndarray>, "data": <np.ndarray>}
        """
        tmo = self.interface.get_visa_attribute(VI_ATTR_TMO_VALUE)
        self.interface.set_visa_attribute(VI_ATTR_TMO_VALUE, 5000)

        ret = self.interface.vi_query(f":ACQ:SOUR{self._Channel}:DATA?")
        self.GetError()

        cn = self.parent.Channels.Name(int(self._Channel))
        tc = self.parent.Channels.Item(cn)
        pa = tc.ProbeAttenuation

        self.interface.set_visa_attribute(VI_ATTR_TMO_VALUE, tmo)

        ret = ret.strip("{}\n\r").replace("  ", "").split(",")
        data = [float(x) * pa for x in ret]

        dec = self.interface.vi_query(":ACQ:DEC?", rformat="%d\n")
        self.GetError()

        # nbuf = self.interface.vi_query(':ACQ:BUF:SIZE?', rformat="%d\n")
        # self.GetError()

        # trig_delay = self.interface.vi_query(':ACQ:TRIG:DLY:NS?', rformat="%f\n")*1.0E-9
        # self.GetError()

        # (decimation*N/2)/fs
        # xInitial = -(dec*nbuf/250.0E+6)-trig_delay
        xInitial = 0.0
        xIncrement = dec / 125.0e6

        return data, xInitial, xIncrement

    def FetchWaveformMeasurement(self, MeasFunction):
        """
        Returns a previously acquired waveform measurement for this channel.
        The acquisition must be made prior to calling this method.
        Call this method separately for each measurement.

        :param MeasFunction: Waveform measurement to be measured.
        :type MeasFunction: IviScopeMeasurementEnum
        """
        raise NotImplementedError

    def ReadWaveform(self, MaxTimeMilliseconds=5000):
        """
        Initiates an acquisition on all enabled channels, waits (up to
        MaxTime) for the acquisition to complete, and returns the waveform
        for this channel. Call FetchWaveform to obtain the waveforms for other
        channels.

        :param MaxTimeMilliseconds:
            Specifies the maximum time the end-user allows for this method to complete in milliseconds.
        :type MaxTimeMilliseconds: int

        :return: Returns a waveform datatype as dictionary of form {"time_scope": <np.ndarray>,
            "data_scope": <np.ndarray>}
        """
        from pverify.drivers.Scope.RedPitaya.IIviScopeAcquisition import IIviScopeAcquisition
        from pverify.drivers.Scope.RedPitaya.IIviScopeMeasurements import IIviScopeMeasurements

        tmpObj_Measurements = IIviScopeMeasurements(self.parent)
        tmpObj_Acquisition = IIviScopeAcquisition(self)

        ElapsedTime = 0

        tmpObj_Measurements.Initiate()
        # sleep(0.5)

        # Wait for acquisition complete
        StartTime = perf_counter()
        while (ElapsedTime * 1000 <= MaxTimeMilliseconds) and (
            tmpObj_Measurements.Status() == self.Enums.IviScopeAcquisitionStatusEnum.IviScopeAcqInProgress
        ):
            sleep(0.2)
            ElapsedTime = perf_counter() - StartTime
        AcqInProg = tmpObj_Measurements.Status() == self.Enums.IviScopeAcquisitionStatusEnum.IviScopeAcqInProgress

        if (ElapsedTime * 1000 > MaxTimeMilliseconds) and AcqInProg:
            msg = "RedPitaya: A timeout occurred while acquisition was in progress"
            raise Exception(msg)

        # Acquisition completed
        if tmpObj_Acquisition.Type == self.Enums.IviScopeAcquisitionTypeEnum.IviScopeAcquisitionTypeAverage:
            tmpObj_Measurements.Abort()
        data, xInitial, xIncrement = self.FetchWaveform()

        tmpObj_Measurements.Abort()

        return data, xInitial, xIncrement

    def ReadWaveformMeasurement(self, MeasFunction, MaxTimeMilliseconds=5000):
        """
        Initiates an acquisition on all enabled channels, waits (up to MaxTimeMilliseconds) for the
        acquisition to complete, and returns the measurement for this channel.

        :param MeasFunction: Waveform measurement to be measured.
        :type MeasFunction: IviScopeMeasurementEnum

        :param MaxTimeMilliseconds:
            Specifies the maximum time the end-user allows for this method to complete in milliseconds.
        :type MaxTimeMilliseconds: int
        """
        raise NotImplementedError

    def FetchWaveformMinMax(self):
        """
        Returns the previously acquired minimum and maximum waveforms for this
        specified channel. The acquisition
            must be made prior to calling
        this method. Call this method separately for each channel.

        Parameter "MinWaveform"
            This array contains the min waveform.

        Parameter "MaxWaveform"
            This array contains the max waveform.

        Parameter "InitialX"
            The time in relation to the Trigger Event of the first point in the
            waveform in seconds.

        Parameter "XIncrement"
            The time between points in the acquired waveform in seconds.

        """
        raise NotImplementedError

    def ReadWaveformMinMax(self, MaxTimeMilliseconds):
        """
        Initiates an acquisition on all enabled channels, waits (up to
        MaxTime) for the acquisition to complete,
        and returns the min/max
        waveforms for this channel. Call FetchMinMaxWaveform to obtain the
        min/max waveforms for
        other channels.

        Parameter "MaxTimeMilliseconds"
            Specifies the maximum time the end-user allows for this method to
            complete in milliseconds. The values defined in
            IviScopeTimeOutEnum are also allowed.

        Parameter "MinWaveform"
            This array contains the min waveform.

        Parameter "MaxWaveform"
            This array contains the max waveform.

        Parameter "InitialX"
            The time in relation to the Trigger Event of the first point in the
            waveform in seconds.

        Parameter "XIncrement"
            The time between points in the acquired waveform in seconds.

        """
        raise NotImplementedError
