# ===========================================================================
# Copyright (C) 2016 Infineon Technologies AG
# All rights reserved.
# ===========================================================================
#
# ===========================================================================
# This document contains proprietary information of Infineon Technologies AG.
# Passing on and copying of this document, and communication of its contents
# is not permitted without Infineon's prior written authorisation.
# ===========================================================================
#
# -------------------------------------------------------------------------------
# Revision       : $Rev$
# Date           : $Date$
# Last change by : $Author$
# -------------------------------------------------------------------------------
"""
IVI Scope class-compliant acquisition interface.
"""

from __future__ import annotations

from pverify.drivers.Scope.RedPitaya import IIviScopeBase


class IIviScopeAcquisition(IIviScopeBase.IIviScopeBase):
    """IVI Scope class-compliant acquisition interface.

    NOTE:
        Attributes/Methods marked with '#' do not exist for this instrument.
        Attributes/Methods marked with '*' are specific for this instrument.
        !Please consider when trying to program instrument independent.

    Attributes:
        #NumberOfAverages [Int] [rw]
            The number of waveforms the oscilloscope acquires and
            averages before returning to the idle state.

        #NumberOfEnvelopes [Int] [rw]
            The number of waveforms the oscilloscope acquires and analyzes to
            create the minimum and maximum waveforms, before returning to the
            idle state. Applies only when acquisition Type is Envelope

        #Interpolation [] [rw]
            The interpolation method the oscilloscope uses when it cannot
            sample a voltage for every point in the waveform record.

        RecordLength [r]
            The actual number of points the oscilloscope acquires for each channel.
            It is equal to or greater than the minimum number of points specified
            with the Horizontal Minimun Number of Points property.

        #SampleMode [r]
            The sample mode the oscilloscope is currently using.
                Values:
                    "IviScopeSampleModeRealTime"
                    #"IviScopeSampleModeEquivalentTime"
                    *"IviScopeSampleModeInterpolate"
                    *"IviScopeSampleModeRepetitive"

        SampleRate [r]
            The effective digitizing rate using the current configuration.
            The units are samples per second.

        Type [String] [rw]
            How the oscilloscope acquires data and fills the waveform record.
            When set to Envelope or Peak Detect, the oscilloscope acquires
            minimum and maximum waveforms.

            RedPitaya: Basically turn averaging on or off

                Values:
                    "IviScopeAcquisitionTypeNormal"
                    #"IviScopeAcquisitionTypePeakDetect"
                    #"IviScopeAcquisitionTypeHiRes"
                    *"IviScopeAcquisitionTypeAverage"

        NumberOfPointsMin [Int] [r#w]
            The minimum number of points which can be in a waveform record for
            each channel. It configures the record length that the oscilloscope
            uses for waveform acquisition.
            The Record Length property returns the actual record length.

        interface
            Specific for instrument connection via VISA.
            Provides interface for wrapped VISA library.

    Methods:
        ConfigureRecord(TimePerRecord, MinNumPts=0, AcquisitionStartTime=0)
            Configures the most commonly used properties of the oscilloscopes
            acquisition subsystem: time per record, minimum record length,
            and the acquisition start time.

    """

    def __init__(self, parent):
        self.parent = parent
        if False:
            from .IIviScope import IIviScope

            self.parent = IIviScope()
        IIviScopeBase.IIviScopeBase.__init__(self, self.parent.interface)

    # Read only dependent properties
    @property
    def RecordLength(self):
        """
        The actual number of points the oscilloscope acquires for each
        channel. It is equal to or greater than the minimum number of points
        specified with the horizontal minimum number of points property.
        """
        ret = self.interface.vi_query(":ACQ:BUF:SIZE?", rformat="%d\n")
        self.GetError()
        return ret

    @property
    def SampleRate(self):
        """
        The effective digitizing rate using the current configuration.
        The units are samples per second.

        :rtype: int
        """
        dec = self.interface.vi_query(":ACQ:DEC?", rformat="%d\n")
        self.GetError()
        dec2freq = {
            1: 125000000,
            8: 15600000,
            64: 1900000,
            1024: 103800,
            8192: 15200,
            65536: 1900,
        }
        return dec2freq[dec]

    @property
    def SampleMode(self):
        """
        The sample mode the oscilloscope is currently using.

        :rtype: IviScopeSampleModeEnum
        """
        # ret = self.interface.vi_query(':ACQ:SAMP?', rformat='%s')
        # self.GetError()
        # return self.Enums.enum_from_value(self.Enums.IviScopeSampleModeEnum, ret)
        raise NotImplementedError

    # Read-write dependent properties
    @property
    def NumberOfAverages(self):
        """
        The number of waveforms the oscilloscope acquires and averages before
        returning to the idle state.

        :rtype: int
        """
        # ret = self.interface.vi_query(':ACQ:AVER:COUN?', rformat="%d\n")
        # self.GetError()
        # return ret
        raise NotImplementedError

    @NumberOfAverages.setter
    def NumberOfAverages(self, value):
        """
        The number of waveforms the oscilloscope acquires and averages before
        returning to the idle state.

        :type value: int
        """
        # self.interface.vi_write(':ACQ:AVER:COUN %d' % value)
        # self.GetError()
        raise NotImplementedError

    @property
    def NumberOfEnvelopes(self):
        """
        The number of waveforms the oscilloscope acquires and analyzes to
        create the minimum and maximum waveforms, before returning to the idle
        state. Applies only when acquisition Type is Envelope.

        :rtype: int
        """
        # ret = self.interface.vi_query(':ACQ:COUN?', rformat="%s\n")
        # self.GetError()
        # if ret == "INF":
        #    return 0
        # else:
        #    return int(ret)
        raise NotImplementedError

    @NumberOfEnvelopes.setter
    def NumberOfEnvelopes(self, value):
        """
        The number of waveforms the oscilloscope acquires and analyzes to
        create the minimum and maximum waveforms, before returning to the idle
        state. Applies only when acquisition Type is Envelope
        Value 0 sets count to INF.

        :type value: int
        """
        # if value > 0:
        #    self.interface.vi_write(':ACQ:COUN %d' % value)
        # else:
        #    self.interface.vi_write(':ACQ:COUN INF')
        # self.GetError()
        raise NotImplementedError

    @property
    def Interpolation(self):
        """
        The interpolation method the oscilloscope uses when it cannot sample a
        voltage for every point in the waveform record.
        """
        raise NotImplementedError

    @Interpolation.setter
    def Interpolation(self, value):
        """
        The interpolation method the oscilloscope uses when it cannot sample a
        voltage for every point in the waveform record.
        """
        raise NotImplementedError

    @property
    def Type(self):
        """
        How the oscilloscope acquires data and fills the waveform record. When
        set to Envelope or Peak Detect, the oscilloscope acquires minimum and
        maximum waveforms.

        RedPitaya: Basically turn averaging on or off

        :rtype: IviScopeAcquisitionTypeEnum
        """
        ret = self.interface.vi_query(":ACQ:AVG?", rformat="%s")
        self.GetError()
        return self.Enums.enum_from_value(self.Enums.IviScopeAcquisitionTypeEnum, ret)

    @Type.setter
    def Type(self, value):
        """
        How the oscilloscope acquires data and fills the waveform record. When
        set to Envelope or Peak Detect, the oscilloscope acquires minimum and
        maximum waveforms.

        :type value: IviScopeAcquisitionTypeEnum
        """
        self.interface.vi_write(f":ACQ:AVG {value.value}")
        self.GetError()

    @property
    def NumberOfPointsMin(self):
        """
        The minimum number of points which can be in a waveform record for
        each channel. It configures the record length that the oscilloscope
        uses for waveform acquisition. The Record Length property returns the
        actual record length.

        :rtype: int
        """
        ret = self.interface.vi_query(":ACQ:BUF:SIZE?", rformat="%d\n")
        self.GetError()
        return ret

    @NumberOfPointsMin.setter
    def NumberOfPointsMin(self, value):
        """
        The minimum number of points which can be in a waveform record for
        each channel. It configures the record length that the oscilloscope
        uses for waveform acquisition. The Record Length property returns the
        actual record length.

        :type value: int
        """
        if value > 16384:
            msg = "RedPitaya: Buffer size is limited to 16384"
            raise ValueError(msg)

    @property
    def StartTime(self):
        """
        The length of time from the trigger event to the first point in the
        waveform record. The units are seconds. If positive, the first point
        in the waveform occurs after the trigger. If negative, the first point
        in the waveform occurs before the trigger.

        :rtype: float
        """
        ret = self.interface.vi_query("ACQ:TRIG:DLY:NS?", rformat="%f\n")
        self.GetError()
        return ret * -1000000.0

    @StartTime.setter
    def StartTime(self, value):
        """
        The length of time from the trigger event to the first point in the
        waveform record. The units are seconds. If positive, the first point
        in the waveform occurs after the trigger. If negative, the first point
        in the waveform occurs before the trigger.

        :type value: float
        """
        self.interface.vi_write("ACQ:TRIG:DLY:NS %d" % int(-value * 1000000.0))
        self.GetError()

    @property
    def TimePerRecord(self):
        """
        The time in seconds that corresponds to the record length.

        :rtype: float
        """
        ret = self.SampleRate
        len = self.RecordLength
        return float(len) / float(ret)

    @TimePerRecord.setter
    def TimePerRecord(self, value):
        """
        The time in seconds that corresponds to the record length.

        :type value: float
        """
        len = self.RecordLength
        # RedPitaya offers only discrete decimation values
        freq2dec = {
            125000000: 1,
            15600000: 8,
            1900000: 64,
            103800: 1024,
            15200: 8192,
            1900: 65536,
        }
        freq = min(freq2dec.keys(), key=lambda x: abs(x - len / value))
        self.interface.vi_write(":ACQ:DEC %d" % freq2dec[freq])
        self.GetError()

    # Methods
    def ConfigureRecord(self, TimePerRecord, MinNumPts=0, AcquisitionStartTime=0):
        """
        Configures the most commonly used properties of the oscilloscope's
        acquisition subsystem: time per record, minimum record length, and the
        acquisition start time.

        :param TimePerRecord:
            Specifies the time per record. This value sets the Horizontal Time Per
            Record property.
        :type TimePerRecord: float

        :param MinNumPts:
            Specifies the minimum number of points the end-user allows in the
            waveform recorded. This value sets the Horizontal Minimum Number of
            Points property.
        :type MinNumPts: int

        :param AcquisitionStartTime:
            Specifies the position of the first point in the waveform record
            relative to the trigger event. This value sets the Acquisition Start
            Time property.
        :type AcquisitionStartTime: int
        """

        self.TimePerRecord = TimePerRecord
        self.NumberOfPointsMin = MinNumPts
        self.StartTime = AcquisitionStartTime
