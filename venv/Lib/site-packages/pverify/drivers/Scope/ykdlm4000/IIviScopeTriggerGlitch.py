# -------------------------------------------------------------------------------
# Name           :
# Description    :
#
# Revision       : $Rev$
# Date           : $Date$
# Last change by : $Author$
# -------------------------------------------------------------------------------
from __future__ import annotations

from pverify.drivers.Scope.ykdlm4000 import IIviScopeBase


class IIviScopeTriggerGlitch(IIviScopeBase.IIviScopeBase):
    def __init__(self, interface, parent):
        IIviScopeBase.IIviScopeBase.__init__(self, interface)
        if False:
            from .IIviScopeTrigger import IIviScopeTrigger
        self.parent: IIviScopeTrigger = parent

    # Read-write dependent properties
    @property
    def condition(self):
        """
        The condition of a pulse that triggers the oscilloscope. The condition
        is either inside or outside of the high and low thresholds.

        :rtype: IviScopeGlitchConditionEnum
        """
        ret = self.interface.vi_query(":TRIG:WIDT:TYPE?", rformat="%s")
        self.GetError()
        return self.Enums.enum_from_value(self.Enums.IviScopeGlitchConditionEnum, ret)

    @condition.setter
    def condition(self, value):
        """
        The condition of a pulse that triggers the oscilloscope. The condition
        is either inside or outside of the high and low thresholds.

        :type value: IviScopeGlitchConditionEnum
        """
        cmd = self.Enums.IviScopeGlitchConditionEnum[value.name]
        self.interface.vi_write(f":TRIG:WIDT:TYPE {cmd.value}")
        self.GetError()

    @property
    def polarity(self):
        """
        The polarity of the pulse that triggers the oscilloscope.

        :rtype: IviScopeGlitchPolarityEnum
        """
        ret = self.interface.vi_query(":TRIG:PULS:POL?", rformat="%s")
        self.GetError()
        return self.Enums.enum_from_value(self.Enums.IviScopeGlitchPolarityEnum, ret)

    @polarity.setter
    def polarity(self, value):
        """
        The polarity of the pulse that triggers the oscilloscope.

        :type value: IviScopeGlitchPolarityEnum
        """
        src = self.parent._source
        try:
            int(src)
        except ValueError:
            msg = f"Cannot set polarity when trigger source is set to {src}!"
            raise Exception(msg) from None
        if int(src) in range(1, 9):
            windowEnabled = self.interface.vi_query(":TRIG:SOUR:CHAN%d:WIND?" % src, rformat="%d")
        else:
            windowEnabled = False
        if not windowEnabled and value in [
            self.Enums.IviScopeGlitchPolarityEnum.IviScopeGlitchPolarityNegative,
            self.Enums.IviScopeGlitchPolarityEnum.IviScopeGlitchPolarityPositive,
        ]:
            cmd = self.Enums.IviScopeGlitchPolarityEnum[value.name]
            self.interface.vi_write(f":TRIG:PULS:POL {cmd.value}")
        self.GetError()

    @property
    def Source(self):
        """
        The signal the oscilloscope monitors for a trigger.

        :rtype: int
        """
        ret = self.interface.vi_query(":TRIG:PULS:SOUR?", rformat="%d\n")
        self.parent._source = ret
        self.GetError()
        return int(ret)

    @Source.setter
    def Source(self, value):
        """
        The signal the oscilloscope monitors for a trigger.

        :param value: Channel number to use as trigger source.
        :type value: int
        """
        self.interface.vi_write(":TRIG:WIDT:COND FALS")
        if (int(value) >= 1) and (int(value) <= 8):
            self.interface.vi_write(":TRIG:PULS:SOUR %d" % value)
            self.parent._source = value
        else:
            raise IndexError("Channel '%d' does not exist." % value)
        self.GetError()

    @property
    def Width(self):
        """
        The glitch width. The units are seconds.
        """
        ret = self.interface.vi_query(":TRIG:WIDT:TIME1?", rformat="%f\n")
        self.GetError()
        return ret

    @Width.setter
    def Width(self, value):
        """
        The glitch width. The units are seconds.
        """
        self.interface.vi_write(f":TRIG:WIDT:TIME1 {value:.3E}")
        self.GetError()

    # Methods
    def Configure(self, Source, Level, Width, Polarity, Condition):
        """
        Configure the glitch trigger Source, Level, Width, Polarity, and
        Condition. A glitch trigger occurs when the edge of a pulse that
        matches the Width and Polarity crosses the specified Level (in Volts).

        :param Source:
            Specifies the trigger source. This value sets the Trigger Source
            property.

        :param Level:
            Specifies the trigger level. This value sets the Trigger Level
            property.

        :param Width:
            Specifies the glitch triggering glitch width in seconds. This value
            sets the Glitch Width property.

        :param Polarity:
            Specifies the glitch polarity. This value sets the Glitch Polarity
            property.

        :param Condition:
            Specifies the glitch condition. This value sets the Glitch Condition
            property.
        """
        if Polarity in [
            self.Enums.IviScopeGlitchPolarityEnum.IviScopeGlitchPolarityPositive,
            self.Enums.IviScopeGlitchPolarityEnum.IviScopeGlitchPolarityNegative,
        ]:
            self.interface.vi_write(":TRIG:WIDT:COND FALS")
            self.Source = Source
            self.polarity = Polarity
            self.Width = Width
            self.condition = Condition
            self.parent.Level = Level

        else:
            msg = "Polarity has to be either IviScopeGlitchPolarityPositive or IviScopeGlitchPolarityNegative."
            raise TypeError(msg)
