from __future__ import annotations

from .ke2450_dllwrap import *


class ke2450_Source_X:
    def __init__(self, parent, function):
        self._parent = parent
        """:type : pverify.drivers.SMU.ke2450.ke2450_Source.ke2450_Source"""
        self._name = self._parent._name
        self._function = function

    @property
    def _vi(self):
        """
        The instrument IO session
        """
        return self._parent._vi

    @property
    def _dllwrap(self):
        """
        The Python dll wrapper module
        """
        return self._parent._dllwrap

    def ConfigureSource(
        self,
        Amplitude=None,
        SourceMode=None,
        Range=None,
        AutoRange=None,
        HiCapMode=None,
        ReadBackState=None,
        AutoDelay=None,
    ):
        """
        Configures the SMU sourcing for the current selected function

        :param Amplitude: the source amplitude
        :type Amplitude: int|float
        :param SourceMode: The source mode. Valid values "norm", "himp", "zero", "guard".

                            When the Model 2450 is set to the normal output-off state, the following settings are made when the source is turned off:

                                - The measurement sense is set to 2-wire
                                - The voltage source is selected and set to 0 V
                                - The current limit is set to 10 % of the full scale of the present measurement function autorange value
                                - If source readback is off, Output Off is displayed in the Home screen Source area
                                - If source readback is on, the actual measurement is displayed in the Home screen Source area
                                - If measurement is set to resistance, dashes (--.----) are shown in the Home screen Source area
                                - The Source button on the Home screen shows the value that will be sourced when the output is turned on again

                            When the high-impedance output-off state is selected and the output is turned off:

                                - The measurement sense is set to 2-wire
                                - The output relay opens, disconnecting the instrument as a load

                                Opening the relay disconnects external circuitry from the inputs and outputs of the instrument. To
                                prevent excessive wear on the output relay, do not use this output-off state for tests that turn the
                                output off and on frequently.
                                The high-impedance output-off state should be used when the instrument is connected to a power
                                source or another source-measure instrument. In some cases, it may also be appropriate for devices
                                such as capacitors.


                            When the zero output-off state is selected and you turn off the output:

                                - The measurement sense is changed to 2-wire
                                - The voltage source is selected and set to 0
                                - The range is set to the presently selected range (turn off autorange)
                                - If the source is voltage, the current limit is not changed
                                - If the source is current, the current limit is set to the programmed source current value or to 10 %
                                  full scale of the present current range, whichever is greater

                                When the zero output-off state is selected, you can use the instrument as an ammeter because it is
                                outputting 0 V.

                            When the guard output-off state is selected and the output is turned off, the following actions occur:

                                - The measurement sense is changed to 2-wire
                                - The current source is selected and set to 0 A if the source is set to current (amps); otherwise, the
                                  output remains a voltage source when the output is turned off
                                - The voltage limit is set to 10 % full scale of the present voltage range

                            Note that the front-panel display does not reflect all of the changes. For example, the 4-wire display

        :type SourceMode: str
        :param Range: Sets or queries the range for the source for the selected source function.

                    +-----------------------+---------------------+
                    |VOLTAGE Range          |CURRENT Range        |
                    +===========+===========+==========+==========+
                    |Model 2450 |Model 2460 |Model 2450|Model 2460|
                    +-----------+-----------+----------+----------+
                    |20mV       |           |10nA      |          |
                    |200mV      |200mV      |100nA     |          |
                    |2V         |2V         |1uA       |1uA       |
                    |           |7V         |10uA      |10uA      |
                    |           |10V        |100uA     |100uA     |
                    |20V        |20V        |1mA       |1mA       |
                    |           |100V       |10mA      |10mA      |
                    |200V       |           |100mA     |100mA     |
                    |           |           |1A        |1A        |
                    |           |           |          |4A        |
                    |           |           |          |5A        |
                    |           |           |          |7A        |
                    +-----------+-----------+----------+----------+

        :type Range: int|float
        :param AutoRange: Enables or disables automatic range selection for the source for the selected source function.
        :type AutoRange: bool
        :param HiCapMode: Enables or disable High Capacitance of source.
        :type HiCapMode: bool
        :param ReadBackState: Sets the Read-Back state.

                              Read-Back state determines if the instrument records the measured source value or the
                              configured source value when making a measurement.

                              Enable this option to increase the measure resolution when measuring resistance and power.
        :type ReadBackState: bool
        :param AutoDelay: Enables or disables the automatic delay that occurs when the source is turned on.

                          When autodelay is turned on, the actual delay that is set depends on the range.

                          When source autodelay is on, if you set a source delay, the autodelay is turned off.

                          When source autodelay is on, the manual source delay setting is overwritten with the autodelay setting.

                          The delay is applied to the first source output and then only when the magnitude of the source changes.
        :type AutoDelay: bool
        """
        if Range is not None:
            self._dllwrap.SetSourceRange(self._vi, self._function, float(Range))

        if AutoRange is not None:
            self._dllwrap.SetEnableAutoRange(self._vi, self._function, bool(AutoRange))

        if Amplitude is not None:
            self._dllwrap.SetSourceAmplitude(self._vi, self._function, Amplitude)

        if SourceMode is not None:
            SourceMode = str(SourceMode).lower()
            if "norm" in SourceMode:
                sm = KE2450_VAL_SOURCE_MODE_NORMAL
            elif "imp" in SourceMode:
                sm = KE2450_VAL_SOURCE_MODE_HIGH_IMPEDANCE
            elif "zero" in SourceMode:
                sm = KE2450_VAL_SOURCE_MODE_ZERO
            elif "guard" in SourceMode:
                sm = KE2450_VAL_SOURCE_MODE_GUARD
            else:
                msg = "Invalid value for parameter 'SourceMode'. Valid: 'norm', 'himp', 'zero', 'guard'."
                raise ValueError(msg)

            self._dllwrap.SetSourceMode2(self._vi, self._name, self._function, sm)

        if HiCapMode is not None:
            self._dllwrap.SetEnableHighCapacitanceMode(self._vi, self._function, bool(HiCapMode))

        if ReadBackState is not None:
            self._dllwrap.SetReadBackState(self._vi, self._function, bool(ReadBackState))

        if AutoDelay is not None:
            self._dllwrap.SetAutoDelay(self._vi, self._function, bool(AutoDelay))

    def ConfigureLinearSweep(
        self,
        Start,
        Stop,
        Points,
        Delay,
        RangeType="auto",
        Count=1,
        FailAbort=True,
        Dual=False,
        BufferName="defbuffer1",
    ):
        """
        Configures a linear sweep for a set number of measurement points

        :param Start: The voltage or current source level at which the sweep starts. Current: -1.05 A to 1.05 A, Voltage: -210 V to 210 V
        :type Start: int|float
        :param Stop: The voltage or current at which the sweep stops. Current: -1.05 A to 1.05 A, Voltage: -210 V to 210 V
        :type Stop: int|float
        :param Points: The number of source-measure points between the start and stop values of the sweep (2 to 1e6);
                       to calculate the number of source-measure points in a sweep, use the following formula: Points = [(Stop - Start) / Step] + 1
        :type Points: int|float
        :param Delay: The delay between measurement points. 50 µs to 10 ks
        :type Delay: int|float
        :param RangeType: The source range that is used for the sweep. Valid values: "auto", "fixed", "best"

                          auto:
                               The instrument selects the most sensitive source range for each source level in the sweep
                          fixed
                               The source remains on the range that is set when the sweep is started.
                               If a sweep point exceeds the source range capability, the source will output the maximum level for that range.
                          best
                               The instrument selects a single fixed source range that will accommodate all the source levels in the sweep.
                               This avoids overshoots during sweeps
        :type RangeType: str
        :param Count: The number of times to run the sweep
        :type Count: int|float
        :param FailAbort: Abort the sweep if the source limit is exceeded
        :type FailAbort: bool
        :param Dual: Determines if the sweep runs from start to stop and then from stop to start
        :type Dual: bool
        :param BufferName: A string that indicates the reading buffer
        :type BufferName: str
        """
        RangeType = str(RangeType).lower()
        if "auto" in RangeType:
            rt = KE2450_VAL_SOURCE_RANGE_TYPE_AUTO
        elif "fix" in RangeType:
            rt = KE2450_VAL_SOURCE_RANGE_TYPE_FIXED
        elif "best" in RangeType:
            rt = KE2450_VAL_SOURCE_RANGE_TYPE_BEST
        else:
            msg = "Invalid value for parameter 'RangeType'. Valid: 'auto', 'fixed', 'best'."
            raise ValueError(msg)

        self._dllwrap.ConfigureLinearSweep(
            self._vi,
            self._function,
            float(Start),
            float(Stop),
            int(Points),
            float(Delay),
            int(Count),
            rt,
            bool(FailAbort),
            bool(Dual),
            str(BufferName),
        )

    def ConfigureLogarithmicSweep(
        self,
        Start,
        Stop,
        Points,
        Delay,
        RangeType="auto",
        Count=1,
        FailAbort=True,
        Dual=False,
        BufferName="defbuffer1",
    ):
        """
        Configure a logarithmic sweep for a set number of measurement points

        log step size = [log10(stop) - log10(start)] / (points - 1)

        :param Start: The voltage or current source level at which the sweep starts. Current: 1 pA to 1.05 A, Voltage: 1 pV to 210 V
        :type Start: int|float
        :param Stop: The voltage or current at which the sweep stops. Current: 1 pA to 1.05 A, Voltage: 1 pV to 210 V
        :type Stop: int|float
        :param Points: The number of source-measure points between the start and stop values of the sweep (2 to 1e6);
                       to calculate the number of source-measure points in a sweep, use the following formula: Points = [(Stop - Start) / Step] + 1
        :type Points: int|float
        :param Delay: The delay between measurement points. 50 µs to 10 ks
        :type Delay: int|float
        :param RangeType: The source range that is used for the sweep. Valid values: "auto", "fixed", "best"

                          auto:
                               The instrument selects the most sensitive source range for each source level in the sweep
                          fixed
                               The source remains on the range that is set when the sweep is started.
                               If a sweep point exceeds the source range capability, the source will output the maximum level for that range.
                          best
                               The instrument selects a single fixed source range that will accommodate all the source levels in the sweep.
                               This avoids overshoots during sweeps
        :type RangeType: str
        :param Count: The number of times to run the sweep
        :type Count: int|float
        :param FailAbort: Abort the sweep if the source limit is exceeded
        :type FailAbort: bool
        :param Dual: Determines if the sweep runs from start to stop and then from stop to start
        :type Dual: bool
        :param BufferName: A string that indicates the reading buffer
        :type BufferName: str
        """
        RangeType = str(RangeType).lower()
        if "auto" in RangeType:
            rt = KE2450_VAL_SOURCE_RANGE_TYPE_AUTO
        elif "fix" in RangeType:
            rt = KE2450_VAL_SOURCE_RANGE_TYPE_FIXED
        elif "best" in RangeType:
            rt = KE2450_VAL_SOURCE_RANGE_TYPE_BEST
        else:
            msg = "Invalid value for parameter 'RangeType'. Valid: 'auto', 'fixed', 'best'."
            raise ValueError(msg)

        self._dllwrap.ConfigureLogarithmicSweep(
            self._vi,
            self._function,
            float(Start),
            float(Stop),
            int(Points),
            float(Delay),
            int(Count),
            rt,
            bool(FailAbort),
            bool(Dual),
            str(BufferName),
        )

    def ConfigureLinearSweepStep(
        self,
        Start,
        Stop,
        Step,
        Delay,
        RangeType="auto",
        Count=1,
        FailAbort=True,
        Dual=False,
        BufferName="defbuffer1",
    ):
        """
        Configures a linear source sweep configuration list and trigger model with a fixed number of steps

        :param Start: The voltage or current source level at which the sweep starts. Current: -1.05 A to 1.05 A, Voltage: -210 V to 210 V
        :type Start: int|float
        :param Stop: The voltage or current at which the sweep stops. Current: -1.05 A to 1.05 A, Voltage: -210 V to 210 V
        :type Stop: int|float
        :param Step: The step size at which the source level will change
        :type Step: int|float
        :param Delay: The delay between measurement points. 50 µs to 10 ks
        :type Delay: int|float
        :param RangeType: The source range that is used for the sweep. Valid values: "auto", "fixed", "best"

                          auto:
                               The instrument selects the most sensitive source range for each source level in the sweep
                          fixed
                               The source remains on the range that is set when the sweep is started.
                               If a sweep point exceeds the source range capability, the source will output the maximum level for that range.
                          best
                               The instrument selects a single fixed source range that will accommodate all the source levels in the sweep.
                               This avoids overshoots during sweeps
        :type RangeType: str
        :param Count: The number of times to run the sweep
        :type Count: int|float
        :param FailAbort: Abort the sweep if the source limit is exceeded
        :type FailAbort: bool
        :param Dual: Determines if the sweep runs from start to stop and then from stop to start
        :type Dual: bool
        :param BufferName: A string that indicates the reading buffer
        :type BufferName: str
        """
        RangeType = str(RangeType).lower()
        if "auto" in RangeType:
            rt = KE2450_VAL_SOURCE_RANGE_TYPE_AUTO
        elif "fix" in RangeType:
            rt = KE2450_VAL_SOURCE_RANGE_TYPE_FIXED
        elif "best" in RangeType:
            rt = KE2450_VAL_SOURCE_RANGE_TYPE_BEST
        else:
            msg = "Invalid value for parameter 'RangeType'. Valid: 'auto', 'fixed', 'best'."
            raise ValueError(msg)

        self._dllwrap.ConfigureLinearSweepStep(
            self._vi,
            self._function,
            float(Start),
            float(Stop),
            float(Step),
            float(Delay),
            int(Count),
            rt,
            bool(FailAbort),
            bool(Dual),
            str(BufferName),
        )

    def ConfigureListSweep(self, Values, Ranges, Delay, BufferName="defbuffer1"):
        """
        Configures the sweep based on a configuration list.

        :param Values: A list of source values to sweep
        :type Values: list[int|float]
        :param Ranges: A list of range values to sweep. If set to None, AutoRange is enabled
        :type Ranges: list[int|float]
        :param Delay: The delay between measurement points. 50 µs to 10 ks
        :type Delay: int|float
        :param BufferName: A string that indicates the reading buffer
        :type BufferName: str
        """
        name_src = "listsweep_src"
        name_meas = "listsweep_meas"
        ref_cl_src = self._parent.ConfigLists
        ref_cl_meas = self._parent._parent.Measure.ConfigLists

        ref_cl_src.Create(name_src)
        ref_cl_meas.Create(name_meas)

        if Ranges is not None and len(Values) != len(Ranges):
            msg = "The length of parameter 'Vales' and 'Ranges' must be equal, except 'Ranges' is set to None!"
            raise Exception(msg)

        for i, v in enumerate(Values):
            if hasattr(self, "SetVoltageLimit"):  # Check if current measured
                self._parent.Current.ConfigureSource(
                    Amplitude=float(v),
                    Range=Ranges[i] if Ranges is not None else None,
                    AutoRange=Ranges is None,
                )
            if hasattr(self, "SetCurrentLimit"):  # Check if voltage measured
                self._parent.Voltage.ConfigureSource(
                    Amplitude=float(v),
                    Range=Ranges[i] if Ranges is not None else None,
                    AutoRange=Ranges is None,
                )
            ref_cl_src.Store(name_src)
            ref_cl_meas.Store(name_meas)

        self._parent._parent._parent.Trigger.ConfigureConfigListTrigger(
            name_meas, name_src, float(Delay), ReadingBuffer=BufferName
        )


class ke2450_Source_V(ke2450_Source_X):
    def __init__(self, parent):
        ke2450_Source_X.__init__(self, parent, KE2450_VAL_FUNCTION2_VOLTAGE)

    def SetCurrentLimit(self, limit):
        """
        Sets the limit for measurements of the voltage function.

        :type limit: int|float
        """
        self._dllwrap.SetAttributeViReal64(self._vi, "", KE2450_ATTR_VOLTAGE_LIMIT, float(limit))


class ke2450_Source_I(ke2450_Source_X):
    def __init__(self, parent):
        ke2450_Source_X.__init__(self, parent, KE2450_VAL_FUNCTION2_CURRENT)

    def SetVoltageLimit(self, limit):
        """
        Sets the limit for measurements of the current function.

        :type limit: int|float
        """
        self._dllwrap.SetAttributeViReal64(self._vi, "", KE2450_ATTR_CURRENT_LIMIT2, float(limit))
