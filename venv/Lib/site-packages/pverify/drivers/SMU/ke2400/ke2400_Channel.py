from __future__ import annotations

from time import sleep

from .ke2400_const import *


class ke2400_Channel:
    def __init__(self, parent, name):
        self._parent = parent
        """:type : pverify.drivers.SMU.ke2400.ke2400.ke2400"""
        self._name = name
        self._measure_fct = None

        from .ke2400_Source import ke2400_Source

        self.__Source = ke2400_Source(self)

        from .ke2400_Measure import ke2400_Measure

        self.__Measure = ke2400_Measure(self)

    @property
    def Source(self):
        """
        Use this property to access the sourcing subclass
        """
        return self.__Source

    @property
    def Measure(self):
        """
        Use this property to access the metering subclass
        """
        return self.__Measure

    def SourceMeterSetup(self, Source, Measure, Performance=None):
        """
        Performs a quick setup of source, measure and performance.

        :param Source: The source function. Valid values: "voltage", "current" or short "vol", "cur"
        :type Source: str
        :param Measure: The measure function. Valid values: "voltage", "current", "resistance", or short "vol", "cur", "res"
        :type Measure: str
        :param Performance: The measurement performance.

            Model ke2400:
                ===  ============  ==============  =========  =========  ============
                0:   ~6.5 digits   ~1     rdgs/s   NPLC=1     Filter=10  AutoZero=On
                1:   ~6.5 digits   ~5     rdgs/s   NPLC=1     Filter=5   AutoZero=On
                2:   ~5.5 digits   ~15    rdgs/s   NPLC=1     Filter=0   AutoZero=On
                3:   ~5.5 digits   ~100   rdgs/s   NPLC=0.1   Filter=0   AutoZero=On
                4:   ~4.5 digits   ~500   rdgs/s   NPLC=0.1   Filter=0   AutoZero=Off
                5:   ~4.5 digits   ~900   rdgs/s   NPLC=0.05  Filter=0   AutoZero=Off
                6:   ~3.5 digits   ~2500  rdgs/s   NPLC=0.01  Filter=0   AutoZero=Off
                ===  ============  ==============  =========  =========  ============
        :type Performance: int
        """
        Measure = str(Measure).lower()
        Source = str(Source).lower()
        ll = self._parent.LowLevel

        # Sourcing setup
        if "cur" in Source:
            ll.Ke24xx_ConfigureSourceMode(KE24XX_SOURCE_CURRENT_FUNCTION, KE24XX_SOURCE_FIXED_MODE)
        elif "vol" in Source:
            ll.Ke24xx_ConfigureSourceMode(KE24XX_SOURCE_VOLTAGE_FUNCTION, KE24XX_SOURCE_FIXED_MODE)
        else:
            msg = "Invalid value for parameter 'Source'. Valid: 'current', 'voltage'."
            raise ValueError(msg)
        sleep(0.1)

        # Metering setup
        if "cur" in Measure:
            if "cur" in Source:
                ll.Ke24xx_SelectSenseFunc(False, True, False)
            elif "vol" in Source:
                # this functions implicitly enables source readback
                ll.Ke24xx_SelectSenseFunc(True, True, False)

            self._measure_fct = KE24XX_READ_CURRENT
            subsys = self.Measure.Current

        elif "vol" in Measure:
            if "cur" in Source:
                # this functions implicitly enables source readback
                ll.Ke24xx_SelectSenseFunc(True, True, False)
            elif "vol" in Source:
                ll.Ke24xx_SelectSenseFunc(True, False, False)
            self._measure_fct = KE24XX_READ_VOLTAGE
            subsys = self.Measure.Voltage

        elif "res" in Measure:
            # this functions implicitly enables source readback
            ll.Ke24xx_SelectSenseFunc(True, True, True)
            self._measure_fct = KE24XX_READ_RESISTANCE
            if "cur" in Source:
                subsys = self.Measure.Voltage
            elif "vol" in Source:
                subsys = self.Measure.Current

        elif "pow" in Measure:
            raise NotImplementedError
        else:
            msg = "Invalid value for parameter 'Function'. Valid: 'current', 'voltage', 'resistance'."
            raise ValueError(msg)

        # Performance setup
        # if Performance is not None and "2450" in self._parent.Identity.InstrumentModel:
        if Performance is not None:
            if not (0 <= Performance <= 6):
                msg = "Invalid value for parameter 'Performance'. Valid: 0...6."
                raise ValueError(msg)
            else:
                funcs = (
                    # Resolution, NPLC, Filter, AutoZero
                    (KE24XX_DISPLAY_6_5_DIGITS, 1, 10, True),
                    (KE24XX_DISPLAY_6_5_DIGITS, 1, 5, True),
                    (KE24XX_DISPLAY_5_5_DIGITS, 1, 0, True),
                    (KE24XX_DISPLAY_5_5_DIGITS, 0.1, 0, True),
                    (KE24XX_DISPLAY_4_5_DIGITS, 0.1, 0, False),
                    (KE24XX_DISPLAY_4_5_DIGITS, 0.05, 0, False),
                    (KE24XX_DISPLAY_3_5_DIGITS, 0.05, 0, False),
                )

                args = funcs[Performance]
                subsys.ConfigureMeasurement(NPLC=args[1], Resolution=args[0], AutoZeroState=args[3])
                subsys.ConfigureAveragingFilter(args[2] > 0, args[2])

        self._parent.Trigger.ResetTriggerModel()
        self._parent.CheckError()
        self._parent.GoToLocal()

    def ResetOutputProtection(self):
        """
        resets the power supply's output protection after an over-voltage or over-current condition occurs.
        """
        raise NotImplementedError
