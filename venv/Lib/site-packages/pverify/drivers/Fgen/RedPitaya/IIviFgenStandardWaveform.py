from __future__ import annotations

from .IIviFgenBase import IIviFgenBase


class IIviFgenStandardWaveform(IIviFgenBase):
    def __init__(self, parent=None):
        super().__init__(self)
        self.parent = parent
        self.pVerifySquare = False  # Workaround for Square waveform is used

    def Configure(self, ChannelName, Waveform, Amplitude, DCOffset, Frequency, StartPhase):
        """
        Configures the function generator attributes that affect standard waveform
        generation. When the Waveform parameter is set to Waveform DC, this function
        ignores the Amplitude, Frequency, and Start Phase parameters.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str
        :param Waveform: Specifies the standard waveform. This value sets the Waveform property
        :type Waveform: IviFgenWaveformEnum
        :param Amplitude: Specifies the waveform amplitude. This value sets the Amplitude property
        :type Amplitude: float
        :param DCOffset: Specifies the waveform's DC offset. This value sets the DC Offset attribute.
        :type DCOffset: float
        :param Frequency: Specifies the waveform frequency. This value sets the Frequency attribute.
        :type Frequency: float
        :param StartPhase: Specifies the waveform start phase. This value sets the Start Phase attribute.
        :type StartPhase: float
        """
        self.set_Waveform(ChannelName, Waveform)
        self.set_Amplitude(ChannelName, Amplitude)
        self.set_DCOffset(ChannelName, DCOffset)
        self.set_Frequency(ChannelName, Frequency)
        self.set_StartPhase(ChannelName, StartPhase)

    def get_DutyCycleHigh(self, ChannelName):
        """
        Retrieves a channel's duty cycle.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str

        :return: The duty cycle for a square waveform. This attribute affects function generator
            behavior only when the Waveform attribute is set to Waveform Square. The value
            is expressed as a percentage.
        :rtype: float
        """
        ret = self.vi_query(f":SOUR{self._ChannelNameToN(ChannelName)}:DCYC?", rformat="%f\n")
        self.GetError()
        return ret

    def set_DutyCycleHigh(self, ChannelName, pVal):
        """
        Sets a channel's duty cycle.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str
        :param pVal: The duty cycle for a square waveform. This attribute affects function generator
            behavior only when the Waveform attribute is set to Waveform Square. The value
            is expressed as a percentage.
        :type pVal: float
        """
        self.vi_write(f":SOUR{self._ChannelNameToN(ChannelName)}:DCYC {pVal:f}")
        self.GetError()
        if self.pVerifySquare:
            self._set_square_arbitrary(ChannelName)

    def get_Amplitude(self, ChannelName):
        """
        Retrieves a channel's amplitude.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str

        :return: The amplitude of the standard waveform output by the function generator. When
            the Waveform attribute is set to Waveform DC, this attribute does not affect
            signal output. The units are volts.
        :rtype: float
        """
        ret = self.vi_query(f":SOUR{self._ChannelNameToN(ChannelName)}:VOLT?", rformat="%f\n")
        self.GetError()
        return ret * 20  # FIXME: RP returns 1/20 of the value

    def set_Amplitude(self, ChannelName, pVal):
        """
        Sets a channel's amplitude.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str
        :param pVal: The amplitude of the standard waveform output by the function generator. When
            the Waveform attribute is set to Waveform DC, this attribute does not affect
            signal output. The units are volts.
        :type pVal: float
        """
        self.vi_write(f":SOUR{self._ChannelNameToN(ChannelName)}:VOLT {pVal:f}")
        self.GetError()

    def get_DCOffset(self, ChannelName):
        """
        Retrieves a channel's DC offset.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str

        :return: The DC offset of the standard waveform output by the function generator. If the
            Waveform attribute is set to Waveform DC, this attribute specifies the DC level
            the function generator produces. The units are volts.
        :rtype: float
        """
        ret = self.vi_query(f":SOUR{self._ChannelNameToN(ChannelName)}:VOLT:OFFS?", rformat="%f\n")
        self.GetError()
        return ret * 20  # FIXME: RP return 1/20 of the value

    def set_DCOffset(self, ChannelName, pVal):
        """
        Sets a channel's DC offset.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str
        :param pVal: The DC offset of the standard waveform output by the function generator. If the
            Waveform attribute is set to Waveform DC, this attribute specifies the DC level
            the function generator produces. The units are volts.
        :type pVal: float
        """
        self.vi_write(f":SOUR{self._ChannelNameToN(ChannelName)}:VOLT:OFFS {pVal:f}")
        self.GetError()

    def get_Frequency(self, ChannelName):
        """
        Retrieves a channel's frequency.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str

        :return: The frequency of the standard waveform output by the function generator. When
            the Waveform attribute is set to Waveform DC, this attribute does not affect
            signal output. The units are Hertz.
        :rtype: float
        """
        ret = self.vi_query(f":SOUR{self._ChannelNameToN(ChannelName)}:FREQ:FIX?", rformat="%f\n")
        self.GetError()
        return ret

    def set_Frequency(self, ChannelName, pVal):
        """
        Sets a channel's frequency.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str
        :param pVal: The frequency of the standard waveform output by the function generator. When
            the Waveform attribute is set to Waveform DC, this attribute does not affect
            signal output. The units are Hertz.
        :type pVal: float
        """
        self.vi_write(f":SOUR{self._ChannelNameToN(ChannelName)}:FREQ:FIX {pVal:f}")
        self.GetError()

    def get_StartPhase(self, ChannelName):
        """
        Retrieves a channel's start phase.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str

        :return: The start phase of the standard waveform output by the function generator. When
            the Waveform attribute is set to Waveform DC, this attribute does not affect
            signal output. The units are degrees.
        :rtype: float
        """
        ret = self.vi_query(f":SOUR{self._ChannelNameToN(ChannelName)}:PHAS?", rformat="%f\n")
        self.GetError()
        return ret

    def set_StartPhase(self, ChannelName, pVal):
        """
        Sets a channel's start phase.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str
        :param pVal: The start phase of the standard waveform output by the function generator. When
            the Waveform attribute is set to Waveform DC, this attribute does not affect
            signal output. The units are degrees.
        :type pVal: float
        """
        self.vi_write(f":SOUR{self._ChannelNameToN(ChannelName)}:PHAS {pVal:f}")
        self.GetError()

    def get_Waveform(self, ChannelName):
        """
        Retrieves a channel's waveform.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str

        :return: The standard waveform output by the function generator.
        :rtype: IviFgenWaveformEnum
        """
        ret = self.vi_query(f":SOUR{self._ChannelNameToN(ChannelName)}:FUNC?", rformat="%s")
        self.GetError()
        if self.pVerifySquare:
            if ret != "ARBITRARY":
                msg = f"RedPitaya: Internal driver error, in emulation mode for Square. Waveform type should be 'ARBITRARY' but is '{ret}'"
                raise ValueError(msg)
            else:
                key = self.Enums.IviFgenWaveformEnum.IviFgenWaveformSquare
        else:
            key = self.Enums.enum_from_value(self.Enums.IviFgenWaveformEnum, ret)
        return key

    def set_Waveform(self, ChannelName, pVal):
        """
        Sets a channel's waveform.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str
        :param pVal: The standard waveform output by the function generator.
        :type pVal: IviFgenWaveformEnum
        """
        if pVal != self.Enums.IviFgenWaveformEnum.IviFgenWaveformSquare:
            self.vi_write(f":SOUR{self._ChannelNameToN(ChannelName)}:FUNC {pVal.value}")
            self.GetError()
            self.pVerifySquare = False
        else:
            self._set_square_arbitrary(ChannelName)

    def _set_square_arbitrary(self, ChannelName):
        """
        Sets the ooutput to an arbitrary waveform with square output.
        This is a workaorunf for the borken PWM mode of RedPitaya.

        :param ChannelName: The ChannelName parameter may be a string defined by the driver or supplied as a
            virtual name in the configuration store. For single output instruments, the
            driver may define the empty string as valid ChannelName.
        :type ChannelName: str
        """
        duty = self.get_DutyCycleHigh(ChannelName) / 100.0
        sm = self.parent.Arbitrary.Waveform.SizeMax
        data = [1.0 if i < sm * duty else -1.0 for x, i in enumerate(range(sm))]
        self.parent.Arbitrary.set_ArbitraryData(ChannelName, data)
        self.pVerifySquare = True
