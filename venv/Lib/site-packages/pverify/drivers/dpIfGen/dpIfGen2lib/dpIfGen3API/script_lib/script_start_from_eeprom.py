from __future__ import annotations

from os.path import abspath, dirname, normpath

from dpIfGen2lib.dpIfGen3API.com_dpifgen3_api_basic import DpIfGen2APIBasicDp3

file_name_absolute = ""
file_name_relative = ""
"""Download and start Firmware From EEPROM
The script:
  - ensures that device has been started from ROM
  - downloads an firmware image to RAM
  - stores the RAM image to EEPROM
  - restarts the device (power cycle)
  - ensures that firmware has been booted from EEPROM
Please specify the image file name to be stored to EEPROM above.
Either use relative path to the location of this script or use absolute path.
"""


def run(image_file):
    DpIfGen2APIBasicDp3.connection_establish()
    if DpIfGen2APIBasicDp3.is_fw_running_in_ram():
        # invalidate RAM
        DpIfGen2APIBasicDp3.store_fw(2)
        # store invalidated image to EEPROM
        DpIfGen2APIBasicDp3.store_fw()
        # reboot device to boot from ROM
        DpIfGen2APIBasicDp3.connection_establish()
        # verify that we have booted from ROM
        if DpIfGen2APIBasicDp3.is_fw_running_in_ram():
            msg = "Firmware not booted from ROM."
            raise Exception(msg)

    DpIfGen2APIBasicDp3.write_eeprom(image_file)
    DpIfGen2APIBasicDp3.app_reset()
    DpIfGen2APIBasicDp3.sync_set()
    # verify that we booted from EEPROM
    if not DpIfGen2APIBasicDp3.is_fw_running_in_ram():
        msg = "Firmware not booted from EEPROM."
        raise Exception(msg)


def main():
    if len(file_name_absolute):
        file_name_full = file_name_absolute
    else:
        this_path = dirname(abspath(__file__))
        if len(file_name_relative) == 0:
            file_name_default = "../../../dpIfGen2lib/test/dp3/support/image_ram.hex"
            file_name_full = normpath("/".join([this_path, file_name_default]))
        else:
            file_name_full = normpath("/".join([this_path, file_name_relative]))
    run(file_name_full)


if __name__ == "__main__":
    main()

# --- End of File ------------------------------------------------
