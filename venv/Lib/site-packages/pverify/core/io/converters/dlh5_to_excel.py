from __future__ import annotations

from pathlib import Path


def dlh5_to_excel(filepath_in: Path | str, filepath_out: Path | str | None = None) -> Path:  # pragma: no cover
    """
    Creates an Excel file from DLH5. Only scalar results (numeric + string), metadata and parameters.

    :param filepath_in: The file path to the result data to be converted
    :param filepath_out: The destination of the converted file.
                         If omitted it will be stored at the input file location with a different file suffix.
    :returns: The path to the converted file.
    """
    import pandas as pd

    from pverify.core.io.pv_dlh5 import PyVerifyDLH5 as DLH5

    filepath_in = Path(filepath_in)
    if filepath_out is None:
        filepath_out = filepath_in.with_suffix(".xlsx")
    filepath_out = Path(filepath_out)
    filepath_out.parent.mkdir(parents=True, exist_ok=True)

    dfs = {}
    with DLH5(filepath_in, "r") as d:
        dfs["File Metadata"] = pd.DataFrame.from_dict(d.file_get_metadata(), orient="index")
        dfs["Data"] = (
            d.get_index_operating_conditions()
            .intersect(
                d.get_index_results(),
                on_merge_conflict="rename",
                suffix_left="_p",
                suffix_right="_r",
            )
            .as_dataframe()
        )
        dfs["Parameters"] = d.get_index_operating_conditions().as_dataframe()
        dfs["Results"] = d.get_index_results().as_dataframe()
        dfs["Group Metadata"] = d.get_index_metadata().as_dataframe()
        dfs["Result Metadata"] = d.get_index_results_metadata().as_dataframe()

    writer = pd.ExcelWriter(str(filepath_out), engine="xlsxwriter")

    for sheetname, df in dfs.items():  # loop through `dict` of dataframes
        df.to_excel(writer, sheet_name=sheetname, freeze_panes=(1, 1))  # send df to writer
        worksheet = writer.sheets[sheetname]  # pull worksheet object
        worksheet.autofit()

    writer.close()

    return filepath_out
