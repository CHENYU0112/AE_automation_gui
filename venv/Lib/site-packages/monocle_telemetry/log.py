import logging
import logging.handlers
import os
import sys

from .const import LOGS_DIR, NO_WRITE_ACCESS

log = logging.getLogger("monocle_telemetry")
log.propagate = False


def setup_logging():
    if len(log.handlers):
        return

    monocle_log_level = getattr(logging, os.environ.get("MONOCLE_LOG_LEVEL", "WARNING"), logging.WARNING)
    if "MONOCLE_DEBUG" in os.environ:
        monocle_log_level = logging.DEBUG

    fmt = logging.Formatter("%(levelname)-7s|%(asctime)s.%(msecs)03d| %(message)s")
    if NO_WRITE_ACCESS:
        h = logging.StreamHandler(sys.stderr)
    else:
        h = logging.handlers.RotatingFileHandler(
            filename=LOGS_DIR / "monocle_telemetry_log.txt", mode="a", maxBytes=1024**2, backupCount=2
        )
    h.setFormatter(fmt)
    log.addHandler(h)
    log.setLevel(monocle_log_level)


setup_logging()
